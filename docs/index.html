<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système Leitner - Gestion de Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icône du site (favicon) -->
    <link rel="icon" type="image/png" href="mordor-2340048_1280.png">
    <!-- Variante avec un .ico classique -->
    <!-- <link rel="icon" href="favicon.ico" type="image/x-icon"> -->

    <style>
        .site-background {
            background-color: #f0f7ff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .flashcard-container, #card-editor, #admin-panel {
            transition: opacity 0.3s ease;
            background-color: rgba(0, 0, 0, 0.8);
        }
        .box-border-1 { border-top: 5px solid #FF6B6B; }
        .box-border-2 { border-top: 5px solid #FFD166; }
        .box-border-3 { border-top: 5px solid #06D6A0; }
        .box-border-4 { border-top: 5px solid #118AB2; }
        .box-border-5 { border-top: 5px solid #073B4C; }
        .text-box1 { color: #FF6B6B; }
        .text-box2 { color: #FFD166; }
        .text-box3 { color: #06D6A0; }
        .text-box4 { color: #118AB2; }
        .text-box5 { color: #073B4C; }
        .card-item {
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-left: 4px solid #6c757d;
        }
        .card-item:hover {
            background-color: #e9ecef;
        }
        .question-content img,
        .answer-content img {
            max-width: 100%;
            max-height: 300px;
            display: block;
            margin: 10px auto;
            border-radius: 5px;
            object-fit: contain;
        }
        .thumbnail-container {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .thumbnail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }
        .card-item:hover .thumbnail-image {
            transform: scale(1.05);
        }
        @media (max-width: 640px) {
            .container {
                padding: 10px;
            }
        }
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            display: none;
        }
        .github-config {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .admin-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #4B5563;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        .interval-input {
            width: 60px;
            text-align: center;
        }
    </style>
</head>
<body class="site-background text-gray-800">
    <div class="container mx-auto max-w-6xl p-5">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Système Leitner</h1>
            <p class="text-gray-600">Apprentissage par répétition espacée</p>
        </header>

        <!-- Section gestion des fichiers -->
        <div class="bg-white rounded-lg shadow-md p-5 mb-6">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Gestion des fichiers CSV</h2>
                <div class="flex flex-wrap gap-2">
                    <button id="add-card-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        + Nouvelle carte
                    </button>
                    <button id="download-csv" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Télécharger CSV
                    </button>
                    <button id="import-csv" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                        Importer CSV
                    </button>
                    <input type="file" id="csv-file" class="hidden" accept=".csv">
                </div>
            </div>

            <div class="mb-4 flex items-center gap-4">
                <select id="csv-selector" class="p-2 border rounded min-w-[250px]">
                    <option value="default">Sélectionner un fichier CSV</option>
                </select>
                <button id="load-csv" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                    Charger
                </button>
                <button id="create-csv" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                    Nouveau CSV
                </button>
            </div>

            <div id="new-csv-form" class="hidden mt-4 p-4 bg-gray-100 rounded">
                <div class="flex items-center gap-2">
                    <input type="text" id="new-csv-name" placeholder="Nom du fichier (sans .csv)" class="p-2 border rounded flex-1">
                    <button id="save-new-csv" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Créer
                    </button>
                </div>
            </div>
        </div>

        <!-- Boîtes Leitner -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
            <!-- Les boîtes seront générées dynamiquement -->
        </div>

        <!-- Liste des cartes -->
        <div id="cards-list-container" class="hidden bg-white rounded-lg shadow-md p-5 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cards-list-title" class="text-xl font-bold">Cartes de la boîte <span id="current-box-number">1</span></h3>
                <button id="close-cards-list" class="text-gray-500 hover:text-gray-700">
                    ✕
                </button>
            </div>
            <div id="cards-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <!-- Éditeur de carte -->
        <div id="card-editor" class="hidden fixed inset-0 flex items-center justify-center p-5 z-50 bg-black bg-opacity-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4" id="editor-title">Nouvelle carte</h3>
                <form id="card-form" class="space-y-4">
                    <input type="hidden" id="card-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Question</label>
                        <textarea id="card-question" class="w-full p-2 border rounded" rows="3" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Image question (URL ou fichier)</label>
                        <div class="flex gap-2">
                            <input type="text" id="card-question-image" class="flex-1 p-2 border rounded" placeholder="https://...">
                            <input type="file" id="question-image-upload" class="hidden" accept="image/*">
                            <button type="button" id="browse-question-image" class="bg-gray-200 px-3 rounded hover:bg-gray-300">Parcourir</button>
                        </div>
                        <img id="question-image-preview" class="image-preview mt-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Réponse</label>
                        <textarea id="card-answer" class="w-full p-2 border rounded" rows="3" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Image réponse (URL ou fichier)</label>
                        <div class="flex gap-2">
                            <input type="text" id="card-answer-image" class="flex-1 p-2 border rounded" placeholder="https://...">
                            <input type="file" id="answer-image-upload" class="hidden" accept="image/*">
                            <button type="button" id="browse-answer-image" class="bg-gray-200 px-3 rounded hover:bg-gray-300">Parcourir</button>
                        </div>
                        <img id="answer-image-preview" class="image-preview mt-2">
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" id="cancel-edit" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Annuler
                        </button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Visualisateur de carte -->
        <div id="flashcard-container" class="hidden fixed inset-0 flex items-center justify-center p-5 z-50 bg-black bg-opacity-50">
            <div class="flashcard bg-white rounded-xl shadow-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="question-section bg-gray-50 rounded-lg p-4 mb-5">
                    <h3 class="font-bold text-lg mb-3">Question</h3>
                    <div id="question-content" class="text-lg my-4"></div>
                    <div id="last-reviewed" class="text-sm text-gray-500 italic"></div>
                </div>
                <button id="show-answer-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 mb-5">
                    Voir la réponse
                </button>
                <div id="answer-section" class="hidden bg-gray-100 rounded-lg p-4 mt-5">
                    <h3 class="font-bold text-lg mb-3">Réponse</h3>
                    <div id="answer-content" class="text-lg my-4"></div>
                    <div class="flex flex-wrap gap-3 mt-6">
                        <button id="wrong-answer" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600">
                            Faux
                        </button>
                        <button id="right-answer" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600">
                            Vrai
                        </button>
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <button id="edit-card-btn" class="text-blue-600 hover:text-blue-800">
                        Modifier
                    </button>
                    <button id="delete-card-btn" class="text-red-600 hover:text-red-800">
                        Supprimer
                    </button>
                </div>
            </div>
        </div>

        <!-- Bouton Admin -->
        <div class="admin-button" id="admin-button">
            ⚙️
        </div>

        <!-- Panel Admin -->
        <div id="admin-panel" class="hidden fixed inset-0 flex items-center justify-center p-5 z-50 bg-black bg-opacity-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Paramètres Administrateur</h3>
                    <button id="close-admin" class="text-gray-500 hover:text-gray-700 text-xl">
                        ✕
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- Configuration GitHub -->
                    <div class="github-config bg-gray-100 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-3">Configuration GitHub</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Propriétaire du dépôt</label>
                                <input type="text" id="repo-owner" class="w-full p-2 border rounded" placeholder="votre-nom-utilisateur">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nom du dépôt</label>
                                <input type="text" id="repo-name" class="w-full p-2 border rounded" placeholder="nom-du-dépôt">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Chemin du dossier (optionnel)</label>
                                <input type="text" id="repo-path" class="w-full p-2 border rounded" placeholder="docs/">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Token d'accès (optionnel)</label>
                                <input type="password" id="github-token" class="w-full p-2 border rounded" placeholder="ghp_xxx">
                                <p class="text-xs text-gray-500 mt-1">Nécessaire seulement pour les dépôts privés</p>
                            </div>
                        </div>
                        <button id="load-github-csv" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Charger les fichiers depuis GitHub
                        </button>
                    </div>

                    <!-- Intervalles de révision -->
                    <div class="intervals-config bg-gray-100 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-3">Intervalles de révision (en heures)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Boîte 1</label>
                                <input type="number" id="interval-1" class="interval-input p-2 border rounded" min="1" value="1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Boîte 2</label>
                                <input type="number" id="interval-2" class="interval-input p-2 border rounded" min="1" value="3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Boîte 3</label>
                                <input type="number" id="interval-3" class="interval-input p-2 border rounded" min="1" value="9">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Boîte 4</label>
                                <input type="number" id="interval-4" class="interval-input p-2 border rounded" min="1" value="27">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Boîte 5</label>
                                <input type="number" id="interval-5" class="interval-input p-2 border rounded" min="1" value="81">
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="save-intervals" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                Sauvegarder les intervalles
                            </button>
                        </div>
                    </div>

                    <!-- Actions administratives -->
                    <div class="admin-actions bg-gray-100 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-3">Actions</h4>
                        <div class="flex flex-wrap gap-2">
                            <button id="reset-all" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                                Réinitialiser toutes les données
                            </button>
                            <button id="export-all" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Exporter toutes les données
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class LeitnerApp {
            constructor() {
                this.flashcards = [];
                this.currentCSV = 'default';
                this.currentCard = null;
                this.currentBoxNumber = 1;
                this.reviewIntervals = [1, 3, 9, 27, 81]; // Intervalles par défaut en heures
                
                this.init();
            }
            
            init() {
                this.loadConfig();
                this.loadIntervals();
                this.createBoxes();
                this.bindEvents();
            }
            
            loadConfig() {
                const config = JSON.parse(localStorage.getItem('leitnerConfig') || '{}');

                // Valeurs par défaut pour la configuration GitHub
                const defaultRepoOwner = 'nibtleithd1';
                const defaultRepoName = 'nibtessv41';
                const defaultRepoPath = 'docs';
                
                if (config.repoOwner) document.getElementById('repo-owner').value = config.repoOwner || defaultRepoOwner;
                if (config.repoName) document.getElementById('repo-name').value = config.repoName || defaultRepoName;
                if (config.repoPath) document.getElementById('repo-path').value = config.repoPath || defaultRepoPath;
                if (config.githubToken) document.getElementById('github-token').value = config.githubToken;
                
                this.loadCSVList();
            }
            loadIntervals() {
                const savedIntervals = JSON.parse(localStorage.getItem('leitnerIntervals'));
                if (savedIntervals && savedIntervals.length === 5) {
                    this.reviewIntervals = savedIntervals;
                }
                
                // Mettre à jour les champs de formulaire
                for (let i = 1; i <= 5; i++) {
                    document.getElementById(`interval-${i}`).value = this.reviewIntervals[i-1];
                }
            }
            
            saveIntervals() {
                const newIntervals = [];
                for (let i = 1; i <= 5; i++) {
                    const value = parseInt(document.getElementById(`interval-${i}`).value) || 1;
                    newIntervals.push(value);
                }
                
                this.reviewIntervals = newIntervals;
                localStorage.setItem('leitnerIntervals', JSON.stringify(this.reviewIntervals));
                this.updateBoxes();
                alert('Intervalles sauvegardés avec succès!');
            }
            
            saveConfig() {
                const config = {
                    repoOwner: document.getElementById('repo-owner').value,
                    repoName: document.getElementById('repo-name').value,
                    repoPath: document.getElementById('repo-path').value,
                    githubToken: document.getElementById('github-token').value
                };
                
                localStorage.setItem('leitnerConfig', JSON.stringify(config));
            }
            
            async loadCSVList() {
                const csvList = JSON.parse(localStorage.getItem('leitnerCSVList') || '[]');
                const selector = document.getElementById('csv-selector');
                
                // Garder l'option par défaut
                selector.innerHTML = '<option value="default">Sélectionner un fichier CSV</option>';
                
                // Ajouter les fichiers CSV sauvegardés
                csvList.forEach(csv => {
                    const option = document.createElement('option');
                    option.value = csv;
                    option.textContent = csv;
                    selector.appendChild(option);
                });
            }
            
            async loadCSVFromGitHub() {
                const repoOwner = document.getElementById('repo-owner').value;
                const repoName = document.getElementById('repo-name').value;
                const repoPath = document.getElementById('repo-path').value;
                const token = document.getElementById('github-token').value;
                
                if (!repoOwner || !repoName) {
                    alert('Veuillez spécifier le propriétaire et le nom du dépôt');
                    return;
                }
                
                // Sauvegarder la configuration
                this.saveConfig();
                
                try {
                    // Construire l'URL de l'API GitHub
                    let apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/`;
                    if (repoPath) apiUrl += repoPath;
                    
                    // Préparer les headers
                    const headers = { 'Accept': 'application/vnd.github.v3+json' };
                    if (token) headers['Authorization'] = `token ${token}`;
                    
                    // Appeler l'API GitHub
                    const response = await fetch(apiUrl, { headers });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur GitHub: ${response.status} ${response.statusText}`);
                    }
                    
                    const contents = await response.json();
                    
                    // Filtrer les fichiers CSV
                    const csvFiles = contents.filter(item => 
                        item.type === 'file' && item.name.endsWith('.csv')
                    );
                    
                    if (csvFiles.length === 0) {
                        alert('Aucun fichier CSV trouvé dans le dépôt');
                        return;
                    }
                    
                    // Mettre à jour la liste déroulante
                    const selector = document.getElementById('csv-selector');
                    
                    // Garder l'option par défaut
                    selector.innerHTML = '<option value="default">Sélectionner un fichier CSV</option>';
                    
                    // Ajouter les fichiers CSV du dépôt GitHub
                    csvFiles.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.name;
                        option.textContent = file.name;
                        option.dataset.downloadUrl = file.download_url;
                        selector.appendChild(option);
                    });
                    
                    // Sauvegarder la liste pour une utilisation hors ligne
                    const csvList = csvFiles.map(file => file.name);
                    localStorage.setItem('leitnerCSVList', JSON.stringify(csvList));
                    
                    alert(`${csvFiles.length} fichier(s) CSV chargé(s) depuis GitHub`);
                    
                } catch (error) {
                    console.error('Erreur de chargement depuis GitHub:', error);
                    alert('Erreur de chargement: ' + error.message);
                }
            }
            
            async loadCSVFromURL(url, csvName) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    const csvContent = await response.text();
                    this.parseAndLoadCSV(csvContent, csvName);
                    
                } catch (error) {
                    console.error('Erreur de chargement du CSV:', error);
                    alert('Erreur de chargement: ' + error.message);
                }
            }
            
            parseAndLoadCSV(csvContent, csvName) {
                const lines = csvContent.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length < 2) {
                    alert('Fichier CSV vide ou mal formaté');
                    return;
                }
                
                // Vérifier l'en-tête
                const headers = lines[0].split(',').map(h => h.trim());
                const expectedHeaders = [
                    'question_content',
                    'question_content_image',
                    'answer_content',
                    'answer_content_image',
                    'box_number',
                    'last_reviewed'
                ];
                
                if (headers.length !== expectedHeaders.length || !expectedHeaders.every((h, i) => headers[i] === h)) {
                    alert('Format de fichier CSV invalide. Les en-têtes doivent être: ' + expectedHeaders.join(', '));
                    return;
                }
                
                // Parser les données
                const importedCards = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    if (values.length < 6) continue;
                    
                    importedCards.push({
                        id: Date.now() + i, // ID unique
                        question: values[0].replace(/^"|"$/g, ''),
                        questionImage: values[1].replace(/^"|"$/g, ''),
                        answer: values[2].replace(/^"|"$/g, ''),
                        answerImage: values[3].replace(/^"|"$/g, ''),
                        box: parseInt(values[4]) || 1,
                        lastReview: new Date(values[5].replace(/^"|"$/g, '')).getTime() || Date.now()
                    });
                }
                
                if (importedCards.length > 0) {
                    this.flashcards = importedCards;
                    this.currentCSV = csvName;
                    this.saveFlashcards();
                    this.updateBoxes();
                    alert(`${importedCards.length} cartes chargées depuis ${csvName}`);
                } else {
                    alert('Aucune carte valide trouvée dans le fichier CSV');
                }
            }
            
            saveCSVList() {
                const csvList = [];
                const selector = document.getElementById('csv-selector');
                
                for (let i = 1; i < selector.options.length; i++) {
                    csvList.push(selector.options[i].value);
                }
                
                localStorage.setItem('leitnerCSVList', JSON.stringify(csvList));
            }
            
            loadFlashcards(csvName) {
                const saved = localStorage.getItem(`leitnerFlashcards_${csvName}`);
                if (saved) {
                    try {
                        this.flashcards = JSON.parse(saved);
                        this.currentCSV = csvName;
                        this.updateBoxes();
                        return true;
                    } catch (e) {
                        console.error('Erreur de chargement des flashcards:', e);
                    }
                }
                
                this.flashcards = [];
                return false;
            }
            
            saveFlashcards() {
                if (this.currentCSV && this.currentCSV !== 'default') {
                    localStorage.setItem(`leitnerFlashcards_${this.currentCSV}`, JSON.stringify(this.flashcards));
                    this.updateBoxes();
                }
            }
            
            exportToCSV() {
                if (this.flashcards.length === 0) {
                    alert('Aucune carte à exporter!');
                    return;
                }
                
                // Entête CSV selon le format demandé
                let csvContent = "question_content,question_content_image,answer_content,answer_content_image,box_number,last_reviewed\n";
                
                // Données des cartes
                this.flashcards.forEach(card => {
                    const row = [
                        `"${card.question.replace(/"/g, '""')}"`,
                        card.questionImage ? `"${card.questionImage.replace(/"/g, '""')}"` : '',
                        `"${card.answer.replace(/"/g, '""')}"`,
                        card.answerImage ? `"${card.answerImage.replace(/"/g, '""')}"` : '',
                        card.box,
                        `"${new Date(card.lastReview).toISOString().split('T')[0]}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // Créer un blob et un lien de téléchargement
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${this.currentCSV}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            importFromCSV(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvContent = e.target.result;
                        this.parseAndLoadCSV(csvContent, file.name);
                    } catch (error) {
                        alert('Erreur lors de l\'importation: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
            
            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                values.push(current);
                return values.map(v => v.trim());
            }
            
            createBoxes() {
                const boxesContainer = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2.md\\:grid-cols-3.lg\\:grid-cols-5.gap-4.mb-6');
                boxesContainer.innerHTML = '';
                
                for (let i = 1; i <= 5; i++) {
                    const box = document.createElement('div');
                    box.className = `box box-border-${i} bg-white rounded-lg shadow-md p-4 text-center cursor-pointer hover:-translate-y-1 transition-transform`;
                    box.dataset.boxNumber = i;
                    
                    const colorClass = `text-box${i}`;
                    
                    box.innerHTML = `
                        <h2 class="text-xl font-bold mb-2 ${colorClass}">Boîte ${i}</h2>
                        <div class="box-counter text-sm text-gray-600">0 carte(s)</div>
                        <div class="box-next-review text-xs text-gray-400 mt-1"></div>
                    `;
                    
                    box.addEventListener('click', () => {
                        this.showCardsList(i);
                    });
                    
                    boxesContainer.appendChild(box);
                }
            }
            
            updateBoxes() {
                for (let i = 1; i <= 5; i++) {
                    const boxCards = this.flashcards.filter(card => card.box === i);
                    const boxElement = document.querySelector(`.box[data-box-number="${i}"]`);
                    
                    if (boxElement) {
                        const counter = boxElement.querySelector('.box-counter');
                        const nextReview = boxElement.querySelector('.box-next-review');
                        
                        counter.textContent = `${boxCards.length} carte(s)`;
                        
                        if (boxCards.length > 0) {
                            const nextReviewTime = this.getNextReviewTime(i);
                            nextReview.textContent = `Prochaine rev.: ${this.formatTime(nextReviewTime)}`;
                        } else {
                            nextReview.textContent = '';
                        }
                    }
                }
            }
            
            getNextReviewTime(boxNumber) {
                const boxCards = this.flashcards.filter(card => card.box === boxNumber);
                if (boxCards.length === 0) return null;
                
                return boxCards.reduce((min, card) => {
                    const cardNextReview = card.lastReview + this.reviewIntervals[card.box - 1] * 3600 * 1000;
                    return Math.min(min, cardNextReview);
                }, Infinity);
            }
            
            formatTime(timestamp) {
                if (!timestamp) return '';
                
                const now = Date.now();
                const date = new Date(timestamp);
                
                if (timestamp <= now) {
                    return 'Maintenant';
                }
                
                const today = new Date();
                if (date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear()) {
                    return date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
                }
                
                return date.toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute:'2-digit'
                });
            }
            
            showCardsList(boxNumber) {
                this.currentBoxNumber = boxNumber;
                const boxCards = this.flashcards.filter(card => card.box === boxNumber);
                const cardsList = document.getElementById('cards-list');
                cardsList.innerHTML = '';
                
                if (boxCards.length === 0) {
                    cardsList.innerHTML = '<p class="text-gray-500">Aucune carte</p>';
                } else {
                    boxCards.forEach(card => {
                        const cardElement = this.createCardElement(card);
                        cardsList.appendChild(cardElement);
                    });
                }
                
                document.getElementById('current-box-number').textContent = boxNumber;
                document.getElementById('cards-list-container').classList.remove('hidden');
                
                // Scroll to the list
                setTimeout(() => {
                    document.getElementById('cards-list-container').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
            
            createCardElement(card) {
                const element = document.createElement('div');
                element.className = 'card-item flex items-start gap-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer';
                element.dataset.cardId = card.id;
                
                let thumbnailHtml = '';
                if (card.questionImage) {
                    thumbnailHtml = `
                        <div class="thumbnail-container flex-shrink-0">
                            <img src="${card.questionImage}" 
                                 alt="Miniature" 
                                 class="thumbnail-image w-12 h-12 object-cover rounded border border-gray-200">
                        </div>
                    `;
                }
                
                const displayText = card.question || (card.questionImage ? 'Carte avec image' : 'Carte sans texte');
                element.innerHTML = `
                    ${thumbnailHtml}
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate">${displayText}</div>
                        <div class="card-next-review text-xs text-gray-500 mt-1">
                            Rev.: ${this.formatTime(card.lastReview + this.reviewIntervals[card.box - 1] * 3600 * 1000)}
                        </div>
                    </div>
                `;
                
                element.addEventListener('click', () => {
                    this.showCardViewer(card);
                });
                
                return element;
            }
            
            showCardViewer(card) {
                this.currentCard = card;
                
                document.getElementById('question-content').innerHTML = '';
                document.getElementById('answer-content').innerHTML = '';
                
                // Afficher la question
                if (card.question) {
                    const textElement = document.createElement('div');
                    textElement.textContent = card.question;
                    document.getElementById('question-content').appendChild(textElement);
                }
                
                if (card.questionImage) {
                    const imgElement = document.createElement('img');
                    imgElement.src = card.questionImage;
                    imgElement.alt = 'Image question';
                    imgElement.className = 'mx-auto my-3 max-w-full max-h-[300px] w-auto h-auto object-scale-down';
                    document.getElementById('question-content').appendChild(imgElement);
                }
                
                // Préparer la réponse
                if (card.answer) {
                    const textElement = document.createElement('div');
                    textElement.textContent = card.answer;
                    document.getElementById('answer-content').appendChild(textElement);
                }
                
                if (card.answerImage) {
                    const imgElement = document.createElement('img');
                    imgElement.src = card.answerImage;
                    imgElement.alt = 'Image réponse';
                    imgElement.className = 'mx-auto my-3 max-w-full max-h-[300px] w-auto h-auto object-scale-down';
                    document.getElementById('answer-content').appendChild(imgElement);
                }
                
                document.getElementById('last-reviewed').textContent = 
                    `Dernière révision: ${new Date(card.lastReview).toLocaleString('fr-FR')}`;
                
                document.getElementById('answer-section').classList.add('hidden');
                document.getElementById('show-answer-btn').style.display = 'block';
                document.getElementById('flashcard-container').classList.remove('hidden');
            }
            
            hideCardViewer() {
                document.getElementById('flashcard-container').classList.add('hidden');
            }
            
            showCardEditor(card = null) {
                const form = document.getElementById('card-form');
                const title = document.getElementById('editor-title');
                
                if (card) {
                    // Mode édition
                    title.textContent = 'Modifier la carte';
                    document.getElementById('card-id').value = card.id;
                    document.getElementById('card-question').value = card.question;
                    document.getElementById('card-question-image').value = card.questionImage || '';
                    document.getElementById('card-answer').value = card.answer;
                    document.getElementById('card-answer-image').value = card.answerImage || '';
                    
                    // Afficher les prévisualisations d'images
                    if (card.questionImage) {
                        document.getElementById('question-image-preview').src = card.questionImage;
                        document.getElementById('question-image-preview').style.display = 'block';
                    }
                    if (card.answerImage) {
                        document.getElementById('answer-image-preview').src = card.answerImage;
                        document.getElementById('answer-image-preview').style.display = 'block';
                    }
                } else {
                    // Mode création
                    title.textContent = 'Nouvelle carte';
                    form.reset();
                    document.getElementById('card-id').value = '';
                    
                    // Cacher les prévisualisations d'images
                    document.getElementById('question-image-preview').style.display = 'none';
                    document.getElementById('answer-image-preview').style.display = 'none';
                }
                
                document.getElementById('card-editor').classList.remove('hidden');
            }
            
            hideCardEditor() {
                document.getElementById('card-editor').classList.add('hidden');
            }
            
            saveCard(cardData) {
                if (cardData.id) {
                    // Modification
                    const index = this.flashcards.findIndex(c => c.id == cardData.id);
                    if (index !== -1) {
                        this.flashcards[index] = {
                            ...this.flashcards[index],
                            question: cardData.question,
                            questionImage: cardData.questionImage,
                            answer: cardData.answer,
                            answerImage: cardData.answerImage
                        };
                    }
                } else {
                    // Nouvelle carte
                    const newId = Date.now(); // ID unique basé sur le timestamp
                    this.flashcards.push({
                        id: newId,
                        question: cardData.question,
                        questionImage: cardData.questionImage,
                        answer: cardData.answer,
                        answerImage: cardData.answerImage,
                        box: 1,
                        lastReview: Date.now()
                    });
                }
                
                this.saveFlashcards();
                this.hideCardEditor();
                
                // Si on était en train de voir une liste, la mettre à jour
                if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                    this.showCardsList(this.currentBoxNumber);
                }
            }
            
            deleteCard(cardId) {
                const index = this.flashcards.findIndex(c => c.id == cardId);
                if (index !== -1) {
                    this.flashcards.splice(index, 1);
                    this.saveFlashcards();
                    this.hideCardViewer();
                    
                    // Si on était en train de voir une liste, la mettre à jour
                    if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                        this.showCardsList(this.currentBoxNumber);
                    }
                }
            }
            
            processAnswer(isCorrect) {
                if (!this.currentCard) return;
                
                this.currentCard.lastReview = Date.now();
                this.currentCard.box = isCorrect ? Math.min(this.currentCard.box + 1, 5) : 1;
                
                // Mettre à jour la carte dans la liste
                const index = this.flashcards.findIndex(c => c.id === this.currentCard.id);
                if (index !== -1) {
                    this.flashcards[index] = this.currentCard;
                }
                
                this.saveFlashcards();
                this.hideCardViewer();
                
                // Si on était en train de voir une liste, la mettre à jour
                if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                    this.showCardsList(this.currentBoxNumber);
                }
            }
            
            resetAllData() {
                if (confirm('Êtes-vous sûr de vouloir réinitialiser toutes les données? Cette action est irréversible.')) {
                    localStorage.clear();
                    this.flashcards = [];
                    this.currentCSV = 'default';
                    this.reviewIntervals = [1, 3, 9, 27, 81];
                    this.loadCSVList();
                    this.updateBoxes();
                    
                    // Réinitialiser les champs d'intervalles
                    for (let i = 1; i <= 5; i++) {
                        document.getElementById(`interval-${i}`).value = this.reviewIntervals[i-1];
                    }
                    
                    alert('Toutes les données ont été réinitialisées.');
                }
            }
            
            exportAllData() {
                const allData = {};
                
                // Exporter la configuration
                allData.config = JSON.parse(localStorage.getItem('leitnerConfig') || '{}');
                
                // Exporter les intervalles
                allData.intervals = JSON.parse(localStorage.getItem('leitnerIntervals') || '[1,3,9,27,81]');
                
                // Exporter la liste des CSV
                allData.csvList = JSON.parse(localStorage.getItem('leitnerCSVList') || '[]');
                
                // Exporter tous les jeux de flashcards
                allData.flashcards = {};
                allData.csvList.forEach(csv => {
                    const saved = localStorage.getItem(`leitnerFlashcards_${csv}`);
                    if (saved) {
                        allData.flashcards[csv] = JSON.parse(saved);
                    }
                });
                
                // Créer un blob et un lien de téléchargement
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `leitner-backup-${new Date().toISOString().split('T')[0]}.json`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            bindEvents() {
                // Bouton Admin
                document.getElementById('admin-button').addEventListener('click', () => {
                    document.getElementById('admin-panel').classList.remove('hidden');
                });
                
                // Fermer le panel Admin
                document.getElementById('close-admin').addEventListener('click', () => {
                    document.getElementById('admin-panel').classList.add('hidden');
                });
                
                // Sauvegarder les intervalles
                document.getElementById('save-intervals').addEventListener('click', () => {
                    this.saveIntervals();
                });
                
                // Réinitialiser toutes les données
                document.getElementById('reset-all').addEventListener('click', () => {
                    this.resetAllData();
                });
                
                // Exporter toutes les données
                document.getElementById('export-all').addEventListener('click', () => {
                    this.exportAllData();
                });
                
                // Charger les fichiers depuis GitHub
                document.getElementById('load-github-csv').addEventListener('click', () => {
                    this.loadCSVFromGitHub();
                });
                
                // Sélection d'un fichier CSV
                document.getElementById('csv-selector').addEventListener('change', (e) => {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    if (selectedOption.dataset.downloadUrl) {
                        if (confirm(`Voulez-vous charger le fichier ${selectedOption.value} depuis GitHub?`)) {
                            this.loadCSVFromURL(selectedOption.dataset.downloadUrl, selectedOption.value);
                        }
                    }
                });
                
                // Bouton nouvelle carte
                document.getElementById('add-card-btn').addEventListener('click', () => {
                    if (this.currentCSV === 'default') {
                        alert('Veuillez d\'abord sélectionner ou créer un fichier CSV');
                        return;
                    }
                    this.showCardEditor();
                });
                
                // Annuler l'édition
                document.getElementById('cancel-edit').addEventListener('click', () => {
                    this.hideCardEditor();
                });
                
                // Fermer la liste des cartes
                document.getElementById('close-cards-list').addEventListener('click', () => {
                    document.getElementById('cards-list-container').classList.add('hidden');
                });
                
                // Soumission du formulaire
                document.getElementById('card-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCard({
                        id: document.getElementById('card-id').value,
                        question: document.getElementById('card-question').value,
                        questionImage: document.getElementById('card-question-image').value,
                        answer: document.getElementById('card-answer').value,
                        answerImage: document.getElementById('card-answer-image').value
                    });
                });
                
                // Boutons dans le visualisateur de carte
                document.getElementById('edit-card-btn').addEventListener('click', () => {
                    this.hideCardViewer();
                    this.showCardEditor(this.currentCard);
                });
                
                document.getElementById('delete-card-btn').addEventListener('click', () => {
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette carte?')) {
                        this.deleteCard(this.currentCard.id);
                    }
                });
                
                // Bouton voir la réponse
                document.getElementById('show-answer-btn').addEventListener('click', () => {
                    document.getElementById('answer-section').classList.remove('hidden');
                    document.getElementById('show-answer-btn').style.display = 'none';
                });
                
                // Gestion des réponses
                document.getElementById('wrong-answer').addEventListener('click', () => {
                    this.processAnswer(false);
                });
                
                document.getElementById('right-answer').addEventListener('click', () => {
                    this.processAnswer(true);
                });
                
                // Charger un CSV
                document.getElementById('load-csv').addEventListener('click', () => {
                    const selectedCSV = document.getElementById('csv-selector').value;
                    if (selectedCSV && selectedCSV !== 'default') {
                        if (this.loadFlashcards(selectedCSV)) {
                            alert(`Fichier "${selectedCSV}" chargé avec ${this.flashcards.length} cartes`);
                        } else {
                            alert(`Création d'un nouveau fichier "${selectedCSV}"`);
                            this.currentCSV = selectedCSV;
                            this.flashcards = [];
                            this.saveFlashcards();
                        }
                    } else {
                        alert('Veuillez sélectionner un fichier CSV');
                    }
                });
                
                // Créer un nouveau CSV
                document.getElementById('create-csv').addEventListener('click', () => {
                    document.getElementById('new-csv-form').classList.remove('hidden');
                });
                
                // Sauvegarder un nouveau CSV
                document.getElementById('save-new-csv').addEventListener('click', () => {
                    const newName = document.getElementById('new-csv-name').value.trim();
                    if (newName) {
                        const csvName = newName.endsWith('.csv') ? newName : `${newName}.csv`;
                        
                        // Ajouter au sélecteur
                        const selector = document.getElementById('csv-selector');
                        const option = document.createElement('option');
                        option.value = csvName;
                        option.textContent = csvName;
                        selector.appendChild(option);
                        selector.value = csvName;
                        
                        // Sauvegarder la liste
                        this.saveCSVList();
                        
                        // Cacher le formulaire
                        document.getElementById('new-csv-form').classList.add('hidden');
                        document.getElementById('new-csv-name').value = '';
                        
                        // Charger le nouveau CSV
                        this.currentCSV = csvName;
                        this.flashcards = [];
                        this.saveFlashcards();
                        
                        alert(`Fichier "${csvName}" créé avec succès!`);
                    } else {
                        alert('Veuillez entrer un nom valide');
                    }
                });
                
                // Exporter en CSV
                document.getElementById('download-csv').addEventListener('click', () => {
                    if (this.currentCSV === 'default') {
                        alert('Veuillez d\'abord sélectionner ou créer un fichier CSV');
                        return;
                    }
                    this.exportToCSV();
                });
                
                // Importer un CSV
                document.getElementById('import-csv').addEventListener('click', () => {
                    document.getElementById('csv-file').click();
                });
                
                document.getElementById('csv-file').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        // Demander le nom du fichier
                        const fileName = prompt('Entrez un nom pour ce fichier CSV:', 
                            e.target.files[0].name.endsWith('.csv') 
                                ? e.target.files[0].name 
                                : `${e.target.files[0].name}.csv`);
                        
                        if (fileName) {
                            // Ajouter au sélecteur
                            const selector = document.getElementById('csv-selector');
                            const option = document.createElement('option');
                            option.value = fileName;
                            option.textContent = fileName;
                            selector.appendChild(option);
                            selector.value = fileName;
                            
                            // Sauvegarder la liste
                            this.saveCSVList();
                            
                            // Importer les données
                            this.importFromCSV(e.target.files[0]);
                        }
                    }
                });
                
                // Gestion des images
                document.getElementById('browse-question-image').addEventListener('click', () => {
                    document.getElementById('question-image-upload').click();
                });
                
                document.getElementById('question-image-upload').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            document.getElementById('card-question-image').value = event.target.result;
                            document.getElementById('question-image-preview').src = event.target.result;
                            document.getElementById('question-image-preview').style.display = 'block';
                        };
                        
                        reader.readAsDataURL(file);
                    }
                });
                
                document.getElementById('browse-answer-image').addEventListener('click', () => {
                    document.getElementById('answer-image-upload').click();
                });
                
                document.getElementById('answer-image-upload').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            document.getElementById('card-answer-image').value = event.target.result;
                            document.getElementById('answer-image-preview').src = event.target.result;
                            document.getElementById('answer-image-preview').style.display = 'block';
                        };
                        
                        reader.readAsDataURL(file);
                    }
                });
                
                // Prévisualisation des images via URL
                document.getElementById('card-question-image').addEventListener('blur', (e) => {
                    if (e.target.value) {
                        document.getElementById('question-image-preview').src = e.target.value;
                        document.getElementById('question-image-preview').style.display = 'block';
                    } else {
                        document.getElementById('question-image-preview').style.display = 'none';
                    }
                });
                
                document.getElementById('card-answer-image').addEventListener('blur', (e) => {
                    if (e.target.value) {
                        document.getElementById('answer-image-preview').src = e.target.value;
                        document.getElementById('answer-image-preview').style.display = 'block';
                    } else {
                        document.getElementById('answer-image-preview').style.display = 'none';
                    }
                });
            }
        }

        // Démarrer l'application
        document.addEventListener('DOMContentLoaded', () => {
            window.leitnerApp = new LeitnerApp();
        });
    </script>
</body>
</html>