<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système Leitner - Gestion de Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .site-background {
            background-color: #f0f7ff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .flashcard-container, #card-editor {
            transition: opacity 0.3s ease;
            background-color: rgba(0, 0, 0, 0.8);
        }
        .box-border-1 { border-top: 5px solid #FF6B6B; }
        .box-border-2 { border-top: 5px solid #FFD166; }
        .box-border-3 { border-top: 5px solid #06D6A0; }
        .box-border-4 { border-top: 5px solid #118AB2; }
        .box-border-5 { border-top: 5px solid #073B4C; }
        .text-box1 { color: #FF6B6B; }
        .text-box2 { color: #FFD166; }
        .text-box3 { color: #06D6A0; }
        .text-box4 { color: #118AB2; }
        .text-box5 { color: #073B4C; }
        .card-item {
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-left: 4px solid #6c757d;
        }
        .card-item:hover {
            background-color: #e9ecef;
        }
        .question-content img,
        .answer-content img {
            max-width: 100%;
            max-height: 300px;
            display: block;
            margin: 10px auto;
            border-radius: 5px;
            object-fit: contain;
        }
        .thumbnail-container {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .thumbnail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }
        .card-item:hover .thumbnail-image {
            transform: scale(1.05);
        }
        @media (max-width: 640px) {
            .container {
                padding: 10px;
            }
        }
        .instructions {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .instructions h2 {
            color: #3182ce;
            margin-bottom: 10px;
        }
        .instructions ol {
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body class="site-background text-gray-800">
    <div class="container mx-auto max-w-6xl p-5">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Système Leitner</h1>
            <p class="text-gray-600">Apprentissage par répétition espacée</p>
        </header>

        <div class="instructions mb-6">
            <h2 class="text-xl font-bold">Instructions d'utilisation</h2>
            <ol class="list-decimal pl-5">
                <li>Créez vos flashcards avec le bouton "Nouvelle carte"</li>
                <li>Cliquez sur une boîte pour voir les cartes qu'elle contient</li>
                <li>Réviser les cartes en cliquant dessus et en évaluant votre connaissance</li>
                <li>Exportez vos flashcards en CSV pour les sauvegarder</li>
                <li>Importez un fichier CSV existant pour charger vos flashcards</li>
            </ol>
            <p class="mt-3 font-semibold">Format CSV requis : question_content,answer_content,box_number,last_reviewed</p>
        </div>

        <!-- Section gestion des decks -->
        <div class="bg-white rounded-lg shadow-md p-5 mb-6">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Gestion des flashcards</h2>
                <div class="flex flex-wrap gap-2">
                    <button id="add-card-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        + Nouvelle carte
                    </button>
                    <button id="export-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Exporter CSV
                    </button>
                    <button id="import-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                        Importer CSV
                    </button>
                    <input type="file" id="import-file" class="hidden" accept=".csv">
                </div>
            </div>
        </div>

        <!-- Boîtes Leitner -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
            <!-- Les boîtes seront générées dynamiquement -->
        </div>

        <!-- Liste des cartes -->
        <div id="cards-list-container" class="hidden bg-white rounded-lg shadow-md p-5 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cards-list-title" class="text-xl font-bold">Cartes de la boîte <span id="current-box-number">1</span></h3>
                <button id="close-cards-list" class="text-gray-500 hover:text-gray-700">
                    ✕
                </button>
            </div>
            <div id="cards-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <!-- Éditeur de carte -->
        <div id="card-editor" class="hidden fixed inset-0 flex items-center justify-center p-5 z-50 bg-black bg-opacity-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4" id="editor-title">Nouvelle carte</h3>
                <form id="card-form" class="space-y-4">
                    <input type="hidden" id="card-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Question</label>
                        <textarea id="card-question" class="w-full p-2 border rounded" rows="3" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Réponse</label>
                        <textarea id="card-answer" class="w-full p-2 border rounded" rows="3" required></textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" id="cancel-edit" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Annuler
                        </button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Visualisateur de carte -->
        <div id="flashcard-container" class="hidden fixed inset-0 flex items-center justify-center p-5 z-50 bg-black bg-opacity-50">
            <div class="flashcard bg-white rounded-xl shadow-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="question-section bg-gray-50 rounded-lg p-4 mb-5">
                    <h3 class="font-bold text-lg mb-3">Question</h3>
                    <div id="question-content" class="text-lg my-4"></div>
                    <div id="last-reviewed" class="text-sm text-gray-500 italic"></div>
                </div>
                <button id="show-answer-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 mb-5">
                    Voir la réponse
                </button>
                <div id="answer-section" class="hidden bg-gray-100 rounded-lg p-4 mt-5">
                    <h3 class="font-bold text-lg mb-3">Réponse</h3>
                    <div id="answer-content" class="text-lg my-4"></div>
                    <div class="flex flex-wrap gap-3 mt-6">
                        <button id="wrong-answer" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600">
                            Faux
                        </button>
                        <button id="right-answer" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600">
                            Vrai
                        </button>
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <button id="edit-card-btn" class="text-blue-600 hover:text-blue-800">
                        Modifier
                    </button>
                    <button id="delete-card-btn" class="text-red-600 hover:text-red-800">
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class LeitnerApp {
            constructor() {
                this.flashcards = [];
                this.currentCard = null;
                this.currentBoxNumber = 1;
                this.reviewIntervals = [1, 3, 9, 27, 81]; // Intervalles en heures
                
                this.init();
            }
            
            init() {
                this.loadFlashcards();
                this.createBoxes();
                this.bindEvents();
            }
            
            loadFlashcards() {
                const saved = localStorage.getItem('leitnerFlashcards');
                if (saved) {
                    try {
                        this.flashcards = JSON.parse(saved);
                    } catch (e) {
                        console.error('Erreur de chargement des flashcards:', e);
                        this.flashcards = [];
                    }
                }
                
                this.updateBoxes();
            }
            
            saveFlashcards() {
                localStorage.setItem('leitnerFlashcards', JSON.stringify(this.flashcards));
                this.updateBoxes();
            }
            
            createBoxes() {
                const boxesContainer = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2.md\\:grid-cols-3.lg\\:grid-cols-5.gap-4.mb-6');
                boxesContainer.innerHTML = '';
                
                for (let i = 1; i <= 5; i++) {
                    const box = document.createElement('div');
                    box.className = `box box-border-${i} bg-white rounded-lg shadow-md p-4 text-center cursor-pointer hover:-translate-y-1 transition-transform`;
                    box.dataset.boxNumber = i;
                    
                    const colorClass = `text-box${i}`;
                    
                    box.innerHTML = `
                        <h2 class="text-xl font-bold mb-2 ${colorClass}">Boîte ${i}</h2>
                        <div class="box-counter text-sm text-gray-600">0 carte(s)</div>
                        <div class="box-next-review text-xs text-gray-400 mt-1"></div>
                    `;
                    
                    box.addEventListener('click', () => {
                        this.showCardsList(i);
                    });
                    
                    boxesContainer.appendChild(box);
                }
            }
            
            updateBoxes() {
                for (let i = 1; i <= 5; i++) {
                    const boxCards = this.flashcards.filter(card => card.box === i);
                    const boxElement = document.querySelector(`.box[data-box-number="${i}"]`);
                    
                    if (boxElement) {
                        const counter = boxElement.querySelector('.box-counter');
                        const nextReview = boxElement.querySelector('.box-next-review');
                        
                        counter.textContent = `${boxCards.length} carte(s)`;
                        
                        if (boxCards.length > 0) {
                            const nextReviewTime = this.getNextReviewTime(i);
                            nextReview.textContent = `Prochaine rev.: ${this.formatTime(nextReviewTime)}`;
                        } else {
                            nextReview.textContent = '';
                        }
                    }
                }
            }
            
            getNextReviewTime(boxNumber) {
                const boxCards = this.flashcards.filter(card => card.box === boxNumber);
                if (boxCards.length === 0) return null;
                
                return boxCards.reduce((min, card) => {
                    const cardNextReview = card.lastReview + this.reviewIntervals[card.box - 1] * 3600 * 1000;
                    return Math.min(min, cardNextReview);
                }, Infinity);
            }
            
            formatTime(timestamp) {
                if (!timestamp) return '';
                
                const now = Date.now();
                const date = new Date(timestamp);
                
                if (timestamp <= now) {
                    return 'Maintenant';
                }
                
                const today = new Date();
                if (date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear()) {
                    return date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
                }
                
                return date.toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute:'2-digit'
                });
            }
            
            showCardsList(boxNumber) {
                this.currentBoxNumber = boxNumber;
                const boxCards = this.flashcards.filter(card => card.box === boxNumber);
                const cardsList = document.getElementById('cards-list');
                cardsList.innerHTML = '';
                
                if (boxCards.length === 0) {
                    cardsList.innerHTML = '<p class="text-gray-500">Aucune carte</p>';
                } else {
                    boxCards.forEach(card => {
                        const cardElement = this.createCardElement(card);
                        cardsList.appendChild(cardElement);
                    });
                }
                
                document.getElementById('current-box-number').textContent = boxNumber;
                document.getElementById('cards-list-container').classList.remove('hidden');
                
                // Scroll to the list
                setTimeout(() => {
                    document.getElementById('cards-list-container').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
            
            createCardElement(card) {
                const element = document.createElement('div');
                element.className = 'card-item flex items-start gap-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer';
                element.dataset.cardId = card.id;
                
                const displayText = card.question || 'Carte sans texte';
                element.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate">${displayText}</div>
                        <div class="text-xs text-gray-500 mt-1">Boîte: ${card.box}</div>
                        <div class="card-next-review text-xs text-gray-500 mt-1">
                            Rev.: ${this.formatTime(card.lastReview + this.reviewIntervals[card.box - 1] * 3600 * 1000)}
                        </div>
                    </div>
                `;
                
                element.addEventListener('click', () => {
                    this.showCardViewer(card);
                });
                
                return element;
            }
            
            showCardViewer(card) {
                this.currentCard = card;
                
                document.getElementById('question-content').innerHTML = '';
                document.getElementById('answer-content').innerHTML = '';
                
                // Afficher la question
                if (card.question) {
                    const textElement = document.createElement('div');
                    textElement.textContent = card.question;
                    document.getElementById('question-content').appendChild(textElement);
                }
                
                // Préparer la réponse
                if (card.answer) {
                    const textElement = document.createElement('div');
                    textElement.textContent = card.answer;
                    document.getElementById('answer-content').appendChild(textElement);
                }
                
                document.getElementById('last-reviewed').textContent = 
                    `Dernière révision: ${new Date(card.lastReview).toLocaleString('fr-FR')}`;
                
                document.getElementById('answer-section').classList.add('hidden');
                document.getElementById('show-answer-btn').style.display = 'block';
                document.getElementById('flashcard-container').classList.remove('hidden');
            }
            
            hideCardViewer() {
                document.getElementById('flashcard-container').classList.add('hidden');
            }
            
            showCardEditor(card = null) {
                const form = document.getElementById('card-form');
                const title = document.getElementById('editor-title');
                
                if (card) {
                    // Mode édition
                    title.textContent = 'Modifier la carte';
                    document.getElementById('card-id').value = card.id;
                    document.getElementById('card-question').value = card.question;
                    document.getElementById('card-answer').value = card.answer;
                } else {
                    // Mode création
                    title.textContent = 'Nouvelle carte';
                    form.reset();
                    document.getElementById('card-id').value = '';
                }
                
                document.getElementById('card-editor').classList.remove('hidden');
            }
            
            hideCardEditor() {
                document.getElementById('card-editor').classList.add('hidden');
            }
            
            saveCard(cardData) {
                if (cardData.id) {
                    // Modification
                    const index = this.flashcards.findIndex(c => c.id == cardData.id);
                    if (index !== -1) {
                        this.flashcards[index] = {
                            ...this.flashcards[index],
                            question: cardData.question,
                            answer: cardData.answer
                        };
                    }
                } else {
                    // Nouvelle carte
                    const newId = Date.now(); // ID unique basé sur le timestamp
                    this.flashcards.push({
                        id: newId,
                        question: cardData.question,
                        answer: cardData.answer,
                        box: 1,
                        lastReview: Date.now()
                    });
                }
                
                this.saveFlashcards();
                this.hideCardEditor();
                
                // Si on était en train de voir une liste, la mettre à jour
                if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                    this.showCardsList(this.currentBoxNumber);
                }
            }
            
            deleteCard(cardId) {
                const index = this.flashcards.findIndex(c => c.id == cardId);
                if (index !== -1) {
                    this.flashcards.splice(index, 1);
                    this.saveFlashcards();
                    this.hideCardViewer();
                    
                    // Si on était en train de voir une liste, la mettre à jour
                    if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                        this.showCardsList(this.currentBoxNumber);
                    }
                }
            }
            
            processAnswer(isCorrect) {
                if (!this.currentCard) return;
                
                this.currentCard.lastReview = Date.now();
                this.currentCard.box = isCorrect ? Math.min(this.currentCard.box + 1, 5) : 1;
                
                // Mettre à jour la carte dans la liste
                const index = this.flashcards.findIndex(c => c.id === this.currentCard.id);
                if (index !== -1) {
                    this.flashcards[index] = this.currentCard;
                }
                
                this.saveFlashcards();
                this.hideCardViewer();
                
                // Si on était en train de voir une liste, la mettre à jour
                if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                    this.showCardsList(this.currentBoxNumber);
                }
            }
            
            exportToCSV() {
                // Entête du CSV selon le format demandé
                let csvContent = "question_content,answer_content,box_number,last_reviewed\n";
                
                // Ajouter chaque carte au CSV
                this.flashcards.forEach(card => {
                    // Échapper les guillemets et formater selon le format demandé
                    const question = `"${card.question.replace(/"/g, '""')}"`;
                    const answer = `"${card.answer.replace(/"/g, '""')}"`;
                    const box = card.box;
                    const lastReviewed = new Date(card.lastReview).toISOString().split('T')[0];
                    
                    csvContent += `${question},${answer},${box},${lastReviewed}\n`;
                });
                
                // Créer un blob et un lien de téléchargement
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                const date = new Date().toISOString().split('T')[0];
                
                link.setAttribute("href", url);
                link.setAttribute("download", `leitner_flashcards_${date}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            importFromCSV(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvData = e.target.result;
                        const lines = csvData.split('\n');
                        const importedCards = [];
                        
                        // Vérifier l'en-tête
                        const header = lines[0].trim();
                        if (header !== "question_content,answer_content,box_number,last_reviewed") {
                            alert("Format de fichier invalide. L'en-tête doit être: question_content,answer_content,box_number,last_reviewed");
                            return;
                        }
                        
                        // Traiter chaque ligne (en ignorant l'en-tête)
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // Parseur CSV simple qui gère les guillemets
                            let inQuotes = false;
                            let currentValue = "";
                            const values = [];
                            
                            for (let j = 0; j < line.length; j++) {
                                const char = line[j];
                                
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    values.push(currentValue);
                                    currentValue = "";
                                } else {
                                    currentValue += char;
                                }
                            }
                            values.push(currentValue);
                            
                            if (values.length >= 4) {
                                const question = values[0].trim();
                                const answer = values[1].trim();
                                const box = parseInt(values[2]) || 1;
                                const lastReview = new Date(values[3]).getTime() || Date.now();
                                
                                importedCards.push({
                                    id: Date.now() + i, // ID unique
                                    question: question,
                                    answer: answer,
                                    box: box,
                                    lastReview: lastReview
                                });
                            }
                        }
                        
                        if (importedCards.length > 0) {
                            if (confirm(`Voulez-vous importer ${importedCards.length} cartes?`)) {
                                this.flashcards = importedCards;
                                this.saveFlashcards();
                                alert('Cartes importées avec succès!');
                            }
                        } else {
                            alert('Aucune carte valide trouvée dans le fichier.');
                        }
                    } catch (error) {
                        alert('Erreur lors de l\'importation: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
            
            bindEvents() {
                // Bouton nouvelle carte
                document.getElementById('add-card-btn').addEventListener('click', () => {
                    this.showCardEditor();
                });
                
                // Annuler l'édition
                document.getElementById('cancel-edit').addEventListener('click', () => {
                    this.hideCardEditor();
                });
                
                // Fermer la liste des cartes
                document.getElementById('close-cards-list').addEventListener('click', () => {
                    document.getElementById('cards-list-container').classList.add('hidden');
                });
                
                // Soumission du formulaire
                document.getElementById('card-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCard({
                        id: document.getElementById('card-id').value,
                        question: document.getElementById('card-question').value,
                        answer: document.getElementById('card-answer').value
                    });
                });
                
                // Boutons dans le visualisateur de carte
                document.getElementById('edit-card-btn').addEventListener('click', () => {
                    this.hideCardViewer();
                    this.showCardEditor(this.currentCard);
                });
                
                document.getElementById('delete-card-btn').addEventListener('click', () => {
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette carte?')) {
                        this.deleteCard(this.currentCard.id);
                    }
                });
                
                // Bouton voir la réponse
                document.getElementById('show-answer-btn').addEventListener('click', () => {
                    document.getElementById('answer-section').classList.remove('hidden');
                    document.getElementById('show-answer-btn').style.display = 'none';
                });
                
                // Gestion des réponses
                document.getElementById('wrong-answer').addEventListener('click', () => {
                    this.processAnswer(false);
                });
                
                document.getElementById('right-answer').addEventListener('click', () => {
                    this.processAnswer(true);
                });
                
                // Export/import
                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportToCSV();
                });
                
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('import-file').click();
                });
                
                document.getElementById('import-file').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.importFromCSV(e.target.files[0]);
                    }
                });
            }
        }

        // Démarrer l'application
        document.addEventListener('DOMContentLoaded', () => {
            window.leitnerApp = new LeitnerApp();
        });
    </script>
</body>
</html>