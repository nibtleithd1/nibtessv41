<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système Leitner - Gestion de Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .site-background {
            background-color: #f0f7ff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .flashcard-container, #card-editor {
            transition: opacity 0.3s ease;
            background-color: rgba(0, 0, 0, 0.8);
        }
        .box-border-1 { border-top: 5px solid #FF6B6B; }
        .box-border-2 { border-top: 5px solid #FFD166; }
        .box-border-3 { border-top: 5px solid #06D6A0; }
        .box-border-4 { border-top: 5px solid #118AB2; }
        .box-border-5 { border-top: 5px solid #073B4C; }
        .text-box1 { color: #FF6B6B; }
        .text-box2 { color: #FFD166; }
        .text-box3 { color: #06D6A0; }
        .text-box4 { color: #118AB2; }
        .text-box5 { color: #073B4C; }
        .card-item {
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-left: 4px solid #6c757d;
        }
        .card-item:hover {
            background-color: #e9ecef;
        }
        .question-content img,
        .answer-content img {
            max-width: 100%;
            max-height: 300px;
            display: block;
            margin: 10px auto;
            border-radius: 5px;
            object-fit: contain;
        }
        .thumbnail-container {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .thumbnail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }
        .card-item:hover .thumbnail-image {
            transform: scale(1.05);
        }
        @media (max-width: 640px) {
            .container {
                padding: 10px;
            }
        }
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            display: none;
        }
        .github-config {
            transition: all 0.3s ease;
        }
        .github-config.collapsed {
            max-height: 60px;
            overflow: hidden;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="site-background text-gray-800">
    <div class="container mx-auto max-w-6xl p-5">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Système Leitner</h1>
            <p class="text-gray-600">Apprentissage par répétition espacée</p>
        </header>

        <!-- Section configuration GitHub -->
        <div id="github-config" class="github-config bg-white rounded-lg shadow-md p-5 mb-6">
            <div class="flex justify-between items-center cursor-pointer" id="toggle-config">
                <h2 class="text-xl font-bold">Configuration GitHub</h2>
                <span class="text-2xl">▼</span>
            </div>
            
            <div id="config-content" class="mt-4">
                <div class="mb-4 p-3 bg-yellow-50 rounded border border-yellow-200">
                    <p class="text-sm text-yellow-800">
                        Pour utiliser cette application, vous devez configurer le chemin vers votre dépôt GitHub contenant les fichiers CSV.
                    </p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Propriétaire du dépôt</label>
                        <input type="text" id="repo-owner" class="w-full p-2 border rounded" placeholder="votre-nom-utilisateur" value="nibtleithd1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom du dépôt</label>
                        <input type="text" id="repo-name" class="w-full p-2 border rounded" placeholder="nom-du-dépôt" value="nibtessv41">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chemin du dossier</label>
                        <input type="text" id="repo-path" class="w-full p-2 border rounded" placeholder="chemin/vers/dossier" value="docs">
                    </div>
                </div>
                <button id="save-config" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Sauvegarder la configuration
                </button>
            </div>
        </div>

        <!-- Section gestion des fichiers -->
        <div class="bg-white rounded-lg shadow-md p-5 mb-6">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Gestion des fichiers CSV</h2>
                <div class="flex flex-wrap gap-2">
                    <button id="add-card-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        + Nouvelle carte
                    </button>
                    <button id="download-csv" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Télécharger CSV
                    </button>
                    <button id="import-csv" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                        Importer CSV
                    </button>
                    <input type="file" id="csv-file" class="hidden" accept=".csv">
                    <button id="refresh-csv" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700" title="Rafraîchir la liste">
                        ↻
                    </button>
                </div>
            </div>

            <div class="mb-4 flex items-center gap-4">
                <select id="csv-selector" class="p-2 border rounded min-w-[250px]">
                    <option value="">Chargement des fichiers CSV...</option>
                </select>
                <button id="load-csv" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                    Charger
                </button>
            </div>

            <div id="csv-status" class="text-sm text-gray-600 mt-2"></div>
        </div>

        <!-- Boîtes Leitner -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
            <!-- Les boîtes seront générées dynamiquement -->
        </div>

        <!-- Liste des cartes -->
        <div id="cards-list-container" class="hidden bg-white rounded-lg shadow-md p-5 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cards-list-title" class="text-xl font-bold">Cartes de la boîte <span id="current-box-number">1</span></h3>
                <button id="close-cards-list" class="text-gray-500 hover:text-gray-700">
                    ✕
                </button>
            </div>
            <div id="cards-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <!-- Éditeur de carte -->
        <div id="card-editor" class="hidden fixed inset-0 flex items-center justify-center p-5 z-50 bg-black bg-opacity-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4" id="editor-title">Nouvelle carte</h3>
                <form id="card-form" class="space-y-4">
                    <input type="hidden" id="card-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Question</label>
                        <textarea id="card-question" class="w-full p-2 border rounded" rows="3" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Image question (URL)</label>
                        <input type="text" id="card-question-image" class="w-full p-2 border rounded" placeholder="https://...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Réponse</label>
                        <textarea id="card-answer" class="w-full p-2 border rounded" rows="3" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Image réponse (URL)</label>
                        <input type="text" id="card-answer-image" class="w-full p-2 border rounded" placeholder="https://...">
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" id="cancel-edit" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Annuler
                        </button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Visualisateur de carte -->
        <div id="flashcard-container" class="hidden fixed inset-0 flex items-center justify-center p-5 z-50 bg-black bg-opacity-50">
            <div class="flashcard bg-white rounded-xl shadow-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="question-section bg-gray-50 rounded-lg p-4 mb-5">
                    <h3 class="font-bold text-lg mb-3">Question</h3>
                    <div id="question-content" class="text-lg my-4"></div>
                    <div id="last-reviewed" class="text-sm text-gray-500 italic"></div>
                </div>
                <button id="show-answer-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 mb-5">
                    Voir la réponse
                </button>
                <div id="answer-section" class="hidden bg-gray-100 rounded-lg p-4 mt-5">
                    <h3 class="font-bold text-lg mb-3">Réponse</h3>
                    <div id="answer-content" class="text-lg my-4"></div>
                    <div class="flex flex-wrap gap-3 mt-6">
                        <button id="wrong-answer" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600">
                            Faux
                        </button>
                        <button id="right-answer" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600">
                            Vrai
                        </button>
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <button id="edit-card-btn" class="text-blue-600 hover:text-blue-800">
                        Modifier
                    </button>
                    <button id="delete-card-btn" class="text-red-600 hover:text-red-800">
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class LeitnerApp {
            constructor() {
                this.flashcards = [];
                this.currentCSV = '';
                this.currentCard = null;
                this.currentBoxNumber = 1;
                this.reviewIntervals = [1, 3, 9, 27, 81]; // Intervalles en heures
                this.githubConfig = {
                    owner: 'nibtleithd1',
                    repo: 'nibtessv41',
                    path: 'docs'
                };
                
                this.init();
            }
            
            init() {
                this.loadConfig();
                this.createBoxes();
                this.bindEvents();
                this.loadCSVList();
            }
            
            loadConfig() {
                const savedConfig = localStorage.getItem('leitnerGitHubConfig');
                if (savedConfig) {
                    try {
                        this.githubConfig = JSON.parse(savedConfig);
                        document.getElementById('repo-owner').value = this.githubConfig.owner;
                        document.getElementById('repo-name').value = this.githubConfig.repo;
                        document.getElementById('repo-path').value = this.githubConfig.path;
                    } catch (e) {
                        console.error('Erreur de chargement de la configuration:', e);
                    }
                }
            }
            
            saveConfig() {
                this.githubConfig = {
                    owner: document.getElementById('repo-owner').value,
                    repo: document.getElementById('repo-name').value,
                    path: document.getElementById('repo-path').value
                };
                
                localStorage.setItem('leitnerGitHubConfig', JSON.stringify(this.githubConfig));
                this.loadCSVList();
                alert('Configuration sauvegardée!');
            }
            
            async loadCSVList() {
                const selector = document.getElementById('csv-selector');
                const status = document.getElementById('csv-status');
                
                selector.innerHTML = '<option value="">Chargement...</option>';
                selector.disabled = true;
                status.textContent = 'Chargement de la liste des fichiers CSV...';
                
                try {
                    const response = await fetch(`https://api.github.com/repos/${this.githubConfig.owner}/${this.githubConfig.repo}/contents/${this.githubConfig.path}`);
                    
                    if (!response.ok) {
                        throw new Error(`Erreur GitHub: ${response.status}`);
                    }
                    
                    const contents = await response.json();
                    const csvFiles = contents.filter(item => 
                        item.type === 'file' && item.name.endsWith('.csv')
                    );
                    
                    selector.innerHTML = '';
                    
                    if (csvFiles.length === 0) {
                        selector.innerHTML = '<option value="">Aucun fichier CSV trouvé</option>';
                        status.textContent = 'Aucun fichier CSV trouvé dans le dépôt.';
                    } else {
                        csvFiles.forEach(file => {
                            const option = document.createElement('option');
                            option.value = file.name;
                            option.textContent = file.name;
                            selector.appendChild(option);
                        });
                        
                        status.textContent = `${csvFiles.length} fichier(s) CSV trouvé(s).`;
                    }
                    
                    selector.disabled = false;
                } catch (error) {
                    console.error('Erreur de chargement des fichiers CSV:', error);
                    selector.innerHTML = '<option value="">Erreur de chargement</option>';
                    status.textContent = `Erreur: ${error.message}. Vérifiez la configuration GitHub.`;
                    selector.disabled = false;
                }
            }
            
            async loadCSVFile(csvName) {
                const status = document.getElementById('csv-status');
                status.textContent = `Chargement de ${csvName}...`;
                
                try {
                    const response = await fetch(`https://raw.githubusercontent.com/${this.githubConfig.owner}/${this.githubConfig.repo}/main/${this.githubConfig.path}/${csvName}`);
                    
                    if (!response.ok) {
                        throw new Error(`Erreur de chargement: ${response.status}`);
                    }
                    
                    const csvContent = await response.text();
                    this.parseCSVContent(csvContent, csvName);
                    status.textContent = `${this.flashcards.length} carte(s) chargée(s) depuis ${csvName}.`;
                    
                } catch (error) {
                    console.error('Erreur de chargement du fichier CSV:', error);
                    status.textContent = `Erreur: ${error.message}`;
                }
            }
            
            parseCSVContent(csvContent, csvName) {
                const lines = csvContent.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length < 2) {
                    alert('Fichier CSV vide ou mal formaté');
                    return;
                }
                
                // Vérifier l'en-tête
                const headers = lines[0].split(',').map(h => h.trim());
                const expectedHeaders = [
                    'question_content',
                    'question_content_image',
                    'answer_content',
                    'answer_content_image',
                    'box_number',
                    'last_reviewed'
                ];
                
                if (headers.length !== expectedHeaders.length || !expectedHeaders.every((h, i) => headers[i] === h)) {
                    alert('Format de fichier CSV invalide. Les en-têtes doivent être: ' + expectedHeaders.join(', '));
                    return;
                }
                
                // Parser les données
                this.flashcards = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    if (values.length < 6) continue;
                    
                    this.flashcards.push({
                        id: Date.now() + i, // ID unique
                        question: values[0].replace(/^"|"$/g, ''),
                        questionImage: values[1].replace(/^"|"$/g, ''),
                        answer: values[2].replace(/^"|"$/g, ''),
                        answerImage: values[3].replace(/^"|"$/g, ''),
                        box: parseInt(values[4]) || 1,
                        lastReview: new Date(values[5].replace(/^"|"$/g, '')).getTime() || Date.now()
                    });
                }
                
                this.currentCSV = csvName;
                this.updateBoxes();
            }
            
            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                values.push(current);
                return values.map(v => v.trim());
            }
            
            saveFlashcards() {
                // Dans cette version, les modifications sont stockées localement
                // mais ne sont pas sauvegardées sur GitHub (lecture seule)
                localStorage.setItem(`leitnerFlashcards_${this.currentCSV}`, JSON.stringify(this.flashcards));
                this.updateBoxes();
            }
            
            exportToCSV() {
                if (this.flashcards.length === 0) {
                    alert('Aucune carte à exporter!');
                    return;
                }
                
                // Entête CSV selon le format demandé
                let csvContent = "question_content,question_content_image,answer_content,answer_content_image,box_number,last_reviewed\n";
                
                // Données des cartes
                this.flashcards.forEach(card => {
                    const row = [
                        `"${card.question.replace(/"/g, '""')}"`,
                        card.questionImage ? `"${card.questionImage.replace(/"/g, '""')}"` : '',
                        `"${card.answer.replace(/"/g, '""')}"`,
                        card.answerImage ? `"${card.answerImage.replace(/"/g, '""')}"` : '',
                        card.box,
                        `"${new Date(card.lastReview).toISOString().split('T')[0]}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // Créer un blob et un lien de téléchargement
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${this.currentCSV}`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            importFromCSV(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvContent = e.target.result;
                        this.parseCSVContent(csvContent, file.name);
                        alert(`${this.flashcards.length} cartes importées avec succès!`);
                    } catch (error) {
                        alert('Erreur lors de l\'importation: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
            
            createBoxes() {
                const boxesContainer = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2.md\\:grid-cols-3.lg\\:grid-cols-5.gap-4.mb-6');
                boxesContainer.innerHTML = '';
                
                for (let i = 1; i <= 5; i++) {
                    const box = document.createElement('div');
                    box.className = `box box-border-${i} bg-white rounded-lg shadow-md p-4 text-center cursor-pointer hover:-translate-y-1 transition-transform`;
                    box.dataset.boxNumber = i;
                    
                    const colorClass = `text-box${i}`;
                    
                    box.innerHTML = `
                        <h2 class="text-xl font-bold mb-2 ${colorClass}">Boîte ${i}</h2>
                        <div class="box-counter text-sm text-gray-600">0 carte(s)</div>
                        <div class="box-next-review text-xs text-gray-400 mt-1"></div>
                    `;
                    
                    box.addEventListener('click', () => {
                        this.showCardsList(i);
                    });
                    
                    boxesContainer.appendChild(box);
                }
            }
            
            updateBoxes() {
                for (let i = 1; i <= 5; i++) {
                    const boxCards = this.flashcards.filter(card => card.box === i);
                    const boxElement = document.querySelector(`.box[data-box-number="${i}"]`);
                    
                    if (boxElement) {
                        const counter = boxElement.querySelector('.box-counter');
                        const nextReview = boxElement.querySelector('.box-next-review');
                        
                        counter.textContent = `${boxCards.length} carte(s)`;
                        
                        if (boxCards.length > 0) {
                            const nextReviewTime = this.getNextReviewTime(i);
                            nextReview.textContent = `Prochaine rev.: ${this.formatTime(nextReviewTime)}`;
                        } else {
                            nextReview.textContent = '';
                        }
                    }
                }
            }
            
            getNextReviewTime(boxNumber) {
                const boxCards = this.flashcards.filter(card => card.box === boxNumber);
                if (boxCards.length === 0) return null;
                
                return boxCards.reduce((min, card) => {
                    const cardNextReview = card.lastReview + this.reviewIntervals[card.box - 1] * 3600 * 1000;
                    return Math.min(min, cardNextReview);
                }, Infinity);
            }
            
            formatTime(timestamp) {
                if (!timestamp) return '';
                
                const now = Date.now();
                const date = new Date(timestamp);
                
                if (timestamp <= now) {
                    return 'Maintenant';
                }
                
                const today = new Date();
                if (date.getDate() === today.getDate() && 
                    date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear()) {
                    return date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
                }
                
                return date.toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute:'2-digit'
                });
            }
            
            showCardsList(boxNumber) {
                this.currentBoxNumber = boxNumber;
                const boxCards = this.flashcards.filter(card => card.box === boxNumber);
                const cardsList = document.getElementById('cards-list');
                cardsList.innerHTML = '';
                
                if (boxCards.length === 0) {
                    cardsList.innerHTML = '<p class="text-gray-500">Aucune carte</p>';
                } else {
                    boxCards.forEach(card => {
                        const cardElement = this.createCardElement(card);
                        cardsList.appendChild(cardElement);
                    });
                }
                
                document.getElementById('current-box-number').textContent = boxNumber;
                document.getElementById('cards-list-container').classList.remove('hidden');
                
                // Scroll to the list
                setTimeout(() => {
                    document.getElementById('cards-list-container').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
            
            createCardElement(card) {
                const element = document.createElement('div');
                element.className = 'card-item flex items-start gap-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer';
                element.dataset.cardId = card.id;
                
                let thumbnailHtml = '';
                if (card.questionImage) {
                    thumbnailHtml = `
                        <div class="thumbnail-container flex-shrink-0">
                            <img src="${card.questionImage}" 
                                 alt="Miniature" 
                                 class="thumbnail-image w-12 h-12 object-cover rounded border border-gray-200">
                        </div>
                    `;
                }
                
                const displayText = card.question || (card.questionImage ? 'Carte avec image' : 'Carte sans texte');
                element.innerHTML = `
                    ${thumbnailHtml}
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate">${displayText}</div>
                        <div class="card-next-review text-xs text-gray-500 mt-1">
                            Rev.: ${this.formatTime(card.lastReview + this.reviewIntervals[card.box - 1] * 3600 * 1000)}
                        </div>
                    </div>
                `;
                
                element.addEventListener('click', () => {
                    this.showCardViewer(card);
                });
                
                return element;
            }
            
            showCardViewer(card) {
                this.currentCard = card;
                
                document.getElementById('question-content').innerHTML = '';
                document.getElementById('answer-content').innerHTML = '';
                
                // Afficher la question
                if (card.question) {
                    const textElement = document.createElement('div');
                    textElement.textContent = card.question;
                    document.getElementById('question-content').appendChild(textElement);
                }
                
                if (card.questionImage) {
                    const imgElement = document.createElement('img');
                    imgElement.src = card.questionImage;
                    imgElement.alt = 'Image question';
                    imgElement.className = 'mx-auto my-3 max-w-full max-h-[300px] w-auto h-auto object-scale-down';
                    document.getElementById('question-content').appendChild(imgElement);
                }
                
                // Préparer la réponse
                if (card.answer) {
                    const textElement = document.createElement('div');
                    textElement.textContent = card.answer;
                    document.getElementById('answer-content').appendChild(textElement);
                }
                
                if (card.answerImage) {
                    const imgElement = document.createElement('img');
                    imgElement.src = card.answerImage;
                    imgElement.alt = 'Image réponse';
                    imgElement.className = 'mx-auto my-3 max-w-full max-h-[300px] w-auto h-auto object-scale-down';
                    document.getElementById('answer-content').appendChild(imgElement);
                }
                
                document.getElementById('last-reviewed').textContent = 
                    `Dernière révision: ${new Date(card.lastReview).toLocaleString('fr-FR')}`;
                
                document.getElementById('answer-section').classList.add('hidden');
                document.getElementById('show-answer-btn').style.display = 'block';
                document.getElementById('flashcard-container').classList.remove('hidden');
            }
            
            hideCardViewer() {
                document.getElementById('flashcard-container').classList.add('hidden');
            }
            
            showCardEditor(card = null) {
                const form = document.getElementById('card-form');
                const title = document.getElementById('editor-title');
                
                if (card) {
                    // Mode édition
                    title.textContent = 'Modifier la carte';
                    document.getElementById('card-id').value = card.id;
                    document.getElementById('card-question').value = card.question;
                    document.getElementById('card-question-image').value = card.questionImage || '';
                    document.getElementById('card-answer').value = card.answer;
                    document.getElementById('card-answer-image').value = card.answerImage || '';
                } else {
                    // Mode création
                    title.textContent = 'Nouvelle carte';
                    form.reset();
                    document.getElementById('card-id').value = '';
                }
                
                document.getElementById('card-editor').classList.remove('hidden');
            }
            
            hideCardEditor() {
                document.getElementById('card-editor').classList.add('hidden');
            }
            
            saveCard(cardData) {
                if (cardData.id) {
                    // Modification
                    const index = this.flashcards.findIndex(c => c.id == cardData.id);
                    if (index !== -1) {
                        this.flashcards[index] = {
                            ...this.flashcards[index],
                            question: cardData.question,
                            questionImage: cardData.questionImage,
                            answer: cardData.answer,
                            answerImage: cardData.answerImage
                        };
                    }
                } else {
                    // Nouvelle carte
                    const newId = Date.now(); // ID unique basé sur le timestamp
                    this.flashcards.push({
                        id: newId,
                        question: cardData.question,
                        questionImage: cardData.questionImage,
                        answer: cardData.answer,
                        answerImage: cardData.answerImage,
                        box: 1,
                        lastReview: Date.now()
                    });
                }
                
                this.saveFlashcards();
                this.hideCardEditor();
                
                // Si on était en train de voir une liste, la mettre à jour
                if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                    this.showCardsList(this.currentBoxNumber);
                }
            }
            
            deleteCard(cardId) {
                const index = this.flashcards.findIndex(c => c.id == cardId);
                if (index !== -1) {
                    this.flashcards.splice(index, 1);
                    this.saveFlashcards();
                    this.hideCardViewer();
                    
                    // Si on était en train de voir une liste, la mettre à jour
                    if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                        this.showCardsList(this.currentBoxNumber);
                    }
                }
            }
            
            processAnswer(isCorrect) {
                if (!this.currentCard) return;
                
                this.currentCard.lastReview = Date.now();
                this.currentCard.box = isCorrect ? Math.min(this.currentCard.box + 1, 5) : 1;
                
                // Mettre à jour la carte dans la liste
                const index = this.flashcards.findIndex(c => c.id === this.currentCard.id);
                if (index !== -1) {
                    this.flashcards[index] = this.currentCard;
                }
                
                this.saveFlashcards();
                this.hideCardViewer();
                
                // Si on était en train de voir une liste, la mettre à jour
                if (!document.getElementById('cards-list-container').classList.contains('hidden')) {
                    this.showCardsList(this.currentBoxNumber);
                }
            }
            
            bindEvents() {
                // Configuration pliable
                document.getElementById('toggle-config').addEventListener('click', () => {
                    const config = document.getElementById('github-config');
                    const content = document.getElementById('config-content');
                    
                    if (config.classList.contains('collapsed')) {
                        config.classList.remove('collapsed');
                        content.style.display = 'block';
                        document.querySelector('#toggle-config span').textContent = '▼';
                    } else {
                        config.classList.add('collapsed');
                        content.style.display = 'none';
                        document.querySelector('#toggle-config span').textContent = '►';
                    }
                });
                
                // Sauvegarder la configuration
                document.getElementById('save-config').addEventListener('click', () => {
                    this.saveConfig();
                });
                
                // Rafraîchir la liste CSV
                document.getElementById('refresh-csv').addEventListener('click', () => {
                    this.loadCSVList();
                });
                
                // Bouton nouvelle carte
                document.getElementById('add-card-btn').addEventListener('click', () => {
                    if (!this.currentCSV) {
                        alert('Veuillez d\'abord charger un fichier CSV');
                        return;
                    }
                    this.showCardEditor();
                });
                
                // Annuler l'édition
                document.getElementById('cancel-edit').addEventListener('click', () => {
                    this.hideCardEditor();
                });
                
                // Fermer la liste des cartes
                document.getElementById('close-cards-list').addEventListener('click', () => {
                    document.getElementById('cards-list-container').classList.add('hidden');
                });
                
                // Soumission du formulaire
                document.getElementById('card-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCard({
                        id: document.getElementById('card-id').value,
                        question: document.getElementById('card-question').value,
                        questionImage: document.getElementById('card-question-image').value,
                        answer: document.getElementById('card-answer').value,
                        answerImage: document.getElementById('card-answer-image').value
                    });
                });
                
                // Boutons dans le visualisateur de carte
                document.getElementById('edit-card-btn').addEventListener('click', () => {
                    this.hideCardViewer();
                    this.showCardEditor(this.currentCard);
                });
                
                document.getElementById('delete-card-btn').addEventListener('click', () => {
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette carte?')) {
                        this.deleteCard(this.currentCard.id);
                    }
                });
                
                // Bouton voir la réponse
                document.getElementById('show-answer-btn').addEventListener('click', () => {
                    document.getElementById('answer-section').classList.remove('hidden');
                    document.getElementById('show-answer-btn').style.display = 'none';
                });
                
                // Gestion des réponses
                document.getElementById('wrong-answer').addEventListener('click', () => {
                    this.processAnswer(false);
                });
                
                document.getElementById('right-answer').addEventListener('click', () => {
                    this.processAnswer(true);
                });
                
                // Charger un CSV
                document.getElementById('load-csv').addEventListener('click', () => {
                    const selectedCSV = document.getElementById('csv-selector').value;
                    if (selectedCSV) {
                        this.loadCSVFile(selectedCSV);
                    } else {
                        alert('Veuillez sélectionner un fichier CSV');
                    }
                });
                
                // Exporter en CSV
                document.getElementById('download-csv').addEventListener('click', () => {
                    if (!this.currentCSV) {
                        alert('Veuillez d\'abord charger un fichier CSV');
                        return;
                    }
                    this.exportToCSV();
                });
                
                // Importer un CSV
                document.getElementById('import-csv').addEventListener('click', () => {
                    document.getElementById('csv-file').click();
                });
                
                document.getElementById('csv-file').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.importFromCSV(e.target.files[0]);
                    }
                });
            }
        }

        // Démarrer l'application
        document.addEventListener('DOMContentLoaded', () => {
            window.leitnerApp = new LeitnerApp();
        });
    </script>
</body>
</html>